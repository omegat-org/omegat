# Fuzzy Matches and Statistics Calculation

Fuzzy match is a core feature of the OmegaT.
It is used under the Matches pane and in the statistics calculation.
It is based on the Levenshtein distance.


## Data flow

The fuzzy matching and statistics calculation process involves several components working together:

- **Interactive Match Finding**:
  1. `MatchesTextArea` (UI) triggers a match search when the active segment changes.
  2. `FindMatchesThread` executes the search in the background to keep the UI responsive.
  3. `FindMatches` (Logic) coordinates the search across the project and external TMs.
  4. `FuzzyMatcher` (Core) performs the segment comparisons using an `ISimilarityCalculator` (e.g., `LevenshteinDistance`).
  5. Results are returned as `NearString` objects and formatted for display by `MatchesVarExpansion`.

- **Batch Statistics Calculation**:
  1. `StatisticsWindow` (UI) initiates calculation threads: `CalcStandardStatistics` (for totals) or `CalcMatchStatistics` (for fuzzy levels).
  2. `CalcMatchStatistics` uses `FindMatches` to determine match levels for each segment in the project.
  3. Results are aggregated into Data Store Objects (DSOs): `StatsResult`, `FileData`, `MatchStatCounts`, and `StatCount`.
  4. The results are consumed by `IStatsConsumer` (e.g., `StatisticsPanel` for display or `Statistics` utility for file output).


## Code structure

### API/SPI
- `src/org/omegat/core/matching/ISimilarityCalculator.java`: Interface for calculating similarity between two strings.
- `src/org/omegat/core/statistics/spi/IStatsConsumer.java`: Interface for consuming statistics results during calculation.
- `src/org/omegat/core/statistics/spi/StatOutputFormat.java`: Enum defining supported output formats for statistics.
- `src/org/omegat/gui/matches/IMatcher.java`: Interface for access to matcher pane functionality, like getting or setting the active match.

### Fuzzy match
- `src/org/omegat/core/matching/NearString.java`: Data object representing a fuzzy match result, including source text, target text, and similarity score.
- `src/org/omegat/core/matching/FuzzyMatcher.java`: Core logic for matching a segment against a collection of segments, used for leveraging and statistics.
- `src/org/omegat/core/matching/LevenshteinDistance.java`: Implementation of `ISimilarityCalculator` using the Levenshtein distance algorithm.

### Statistics calculation

#### Data Store Objects
- `src/org/omegat/core/statistics/dso/FileData.java`: Statistics data for a single file.
- `src/org/omegat/core/statistics/dso/MatchStatCounts.java`: Holds counts for different match levels (exact, 95%, etc.).
- `src/org/omegat/core/statistics/dso/StatCount.java`: Basic statistics counter (segments, words, characters).
- `src/org/omegat/core/statistics/dso/StatisticsInfo.java`: Simple container for storing generic statistic data.
- `src/org/omegat/core/statistics/dso/StatProjectProperties.java`: Data class for storing project properties in statistics output (XML/JSON).
- `src/org/omegat/core/statistics/dso/StatsResult.java`: Root object for project statistics results.

#### Statistics Calculation threads
- `src/org/omegat/core/statistics/CalcMatchStatistics.java`: Thread for calculating match statistics (fuzzy matches) for the project.
- `src/org/omegat/core/statistics/CalcStandardStatistics.java`: Thread for calculating standard statistics (totals, unique, remaining).

#### Statistics Calculation logic
- `src/org/omegat/core/statistics/FindMatches.java`: Utility class to find matches for a given segment from various sources.

#### Statistics Calculation logic utilities
- `src/org/omegat/core/statistics/Statistics.java`: Utility methods for statistics calculation and output.
- `src/org/omegat/core/statistics/StatisticsSettings.java`: Accessor for statistics-related preferences.

### Fuzzy Matches UI
- `src/org/omegat/gui/matches/FindMatchesThread.java`: Thread that triggers match finding for the UI.
- `src/org/omegat/gui/matches/MatchesTextArea.java`: UI component that displays fuzzy matches in the OmegaT main window.

### Fuzzy Matches entries template
- `src/org/omegat/gui/matches/MatchesVarExpansion.java`: Handles template-based expansion of variables in match display.

### Statistics Calculation UI
#### Base frame
- `src/org/omegat/gui/stat/StatisticsWindow.java`: Main window frame for displaying statistics.

#### Statistics panels
- `src/org/omegat/gui/stat/StatisticsPanel.java`: Base panel for displaying standard statistics.
- `src/org/omegat/gui/stat/TitledTablePanel.java`: A panel with a title and a table, used for various statistics reports.
- `src/org/omegat/gui/stat/MatchStatisticsPanel.java`: Panel for displaying project-wide match statistics.
- `src/org/omegat/gui/stat/PerFileMatchStatisticsPanel.java`: Panel for displaying per-file match statistics.

## How it works

### Fuzzy match

The core of fuzzy matching is the calculation of the distance between two segments. OmegaT primarily uses the Levenshtein distance, but the system is designed to be extensible via the `ISimilarityCalculator` interface.

`FindMatches` implements a multi-pass matching strategy to improve result quality:
1.  **Stemmed tokens**: Comparison of word-only tokens using a stemmer and stop words.
2.  **Word tokens**: Comparison of word-only tokens without a stemmer.
3.  **Full tokens**: Comparison of all tokens, including numbers and tags.

### Statistics calculation

Statistics calculation is divided into:
- **Standard Statistics**: Counts segments, words, and characters. It identifies unique segments and segments remaining to be translated.
- **Match Statistics**: Categorizes segments based on their best fuzzy match score found in the project's TMs. Standard ranges are: Repetitions, Exact Match, 95-100%, 85-94%, 75-84%, 50-74%, and No Match.

The calculation is typically performed in background threads (`CalcStandardStatistics`, `CalcMatchStatistics`) to keep the UI responsive, and results are aggregated into Data Store Objects (DSOs) like `StatsResult`.

