# Fuzzy Matches and Statistics Calculation

## 1. Purpose and scope

Fuzzy matching in OmegaT identifies similarities between a source segment and existing translations to aid the translation process and provide effort estimates.

- **Primary Uses**:
    - **Matches Pane**: Real-time lookup of similar segments from project and external Translation Memories (TMs).
    - **Statistics Calculation**: Batch processing to categorize project segments by match quality for project management and billing.
- **Coverage**: This document details the token-based scoring model, the multi-pass matching strategy, penalty application, and how statistics (word counts, buckets) are derived.
- **Out of Scope**: UI implementation details (CSS/layout), TMX file format specifications, and unrelated machine translation or glossary lookup mechanisms.

## 2. Glossary

| Term                       | Definition                                                                                                  |
|:---------------------------|:------------------------------------------------------------------------------------------------------------|
| **Segment**                | The basic unit of translation (usually a sentence), defined by segmentation rules.                          |
| **Entry**                  | A segment within the project, potentially appearing multiple times.                                         |
| **Source / Translation**   | The original text versus its translated counterpart.                                                        |
| **Match**                  | A candidate translation from a TM that meets the minimum similarity threshold.                              |
| **Candidate**              | Any segment from a TM considered during the matching process.                                               |
| **Similarity**             | A percentage (0-100) indicating how closely two segments match.                                             |
| **Distance**               | The number of edits (insertions, deletions, substitutions) required to transform one sequence into another. |
| **Translated Text**        | A segment already translated in the current project. In matching: a 100% identical source and context.      |
| **Exact Match**            | A 100% identical source, and may or may not the same context.                                               |
| **Context**                | The context, which contains id, before and after segments, in which the source segment appears.             |
| **Unique**                 | The first occurrence of a source segment in the project.                                                    |
| **Repetition**             | Subsequent occurrences of an identical source segment.                                                      |
| **Remaining**              | Segments that have not yet been translated.                                                                 |
| **Tags / Protected Parts** | Non-translatable elements (e.g., `<a1>`) or text protected by rules/placeholders.                           |
| **Threshold**              | The minimum similarity required for a match to be displayed or categorized (default: 30%).                  |
| **Penalty**                | A score reduction applied to matches based on specific criteria (e.g., differing tags).                     |

## 3. Architecture overview

The fuzzy matching system coordinates between UI requests and batch background processes.

### 3.1 Interactive Match Finding (Matches Pane)
1.  **Trigger**: Active segment changes in the editor.
2.  **Thread**: `FindMatchesThread` initiates a background search.
3.  **Coordination**: `FindMatches` queries the project TM, external TMs, and other source files.
4.  **Comparison**: `FuzzyMatcher` uses an `ISimilarityCalculator` (typically `LevenshteinDistance`) to compare tokenized streams.
5.  **Output**: `NearString` objects are returned, formatted via `MatchesVarExpansion`, and displayed.

### 3.2 Batch Statistics Calculation
1.  **Trigger**: User selects "Project -> Tools -> Statistics" or "Match Statistics".
2.  **Process**: `CalcStandardStatistics` (basic counts) or `CalcMatchStatistics` (fuzzy levels) runs as a `LongProcessThread`.
3.  **Core Logic**: `CalcMatchStatistics` iterates through all segments, using `FindMatches` logic to determine the best match level per segment.
4.  **Aggregation**: Results are stored in Data Store Objects (e.g., `MatchStatCounts`, `StatsResult`).
5.  **Output**: Data is passed to `IStatsConsumer` callback for UI display or file export (Text/XML/JSON).

### 3.3 Key Invariants
- **Consistency**: Statistics calculation and the Matches pane use the same underlying `FindMatches` logic for scoring.
- **Precedence**: In statistics, "already translated" and "repetitions" take precedence over fuzzy matches from external TMs.
- **Determinism**: Matches are sorted by score, then by specific tiebreak rules to ensure stable presentation.

### 3.4 Code Structure

| Group               | Path / Responsibility                                          | Why you'd go there                                                          |
|:--------------------|:---------------------------------------------------------------|:----------------------------------------------------------------------------|
| **API / SPI**       | `org.omegat.core.matching.ISimilarityCalculator`               | To implement custom similarity algorithms or new statistics output formats. |
| **Core Matching**   | `org.omegat.core.matching.FuzzyMatcher`, `LevenshteinDistance` | To modify the fundamental scoring formula or distance calculation.          |
| **Search Logic**    | `org.omegat.core.statistics.FindMatches`                       | To adjust the multi-pass strategy, penalties, or TM search order.           |
| **Statistics Core** | `org.omegat.core.statistics.Calc*Statistics`                   | To change how segments/words are counted or how buckets are defined.        |
| **Data Storage**    | `org.omegat.core.statistics.dso.*`                             | To add new statistics output formats or change the way existing ones work.  | 
| **UI Integration**  | `org.omegat.gui.matches.*`, `org.omegat.gui.stat.*`            | To modify the Matches pane behavior or the Statistics window display.       |

* API: Application Programming Interface
* SPI: Service Provider Interface
* DSO: Data Storage Object
* UI: User Interface
 
### 3.5 How it works

Matching is a multi-stage process that prioritizes speed and then precision.

1.  **Candidate Retrieval**: TMs are indexed and queried to find potential candidates (multi-pass).
2.  **Scoring**: Each candidate is compared to the source using token-based Levenshtein distance (§4).
3.  **Refinement**: Tokenization and normalization (§5) ensure that trivial differences (case, tags) are handled according to user settings.
4.  **Penalties**: Adjustments are applied for mismatches in tags, fuzzy flags, or TMX origin (§6).
5.  **Ranking**: Candidates are filtered by threshold and sorted to find the "best" match.

## 4. Similarity scoring model

OmegaT uses a token-based Levenshtein distance model rather than a character-based one.

### 4.1 The Formula
Similarity is calculated as the inverse of the edit distance, normalized by the length of the longer segment:

$$Similarity = \frac{100 \times (\max(L_{src}, L_{cand}) - Distance)}{\max(L_{src}, L_{cand})}$$

*Where $L$ is the number of tokens in the source and candidate.*

### 4.2 Multi-pass Scoring
The search in `FindMatches` performs up to three passes to find the best candidate:
1.  **Stemmed Pass**: Uses word stems and stop words (e.g., "running" → "run"). Highest recall.
2.  **Non-Stemmed Pass**: Uses normalized word forms but without stemming.
3.  **Verbatim (Full) Pass**: Includes all tokens (tags, numbers, punctuation). Highest precision.

The best score across these passes (after penalties) is selected.

## 5. Tokenization & normalization

Tokenization converts raw text into a sequence of units for comparison.

- **Case Handling**: Comparisons are generally case-insensitive.
- **Word Tokens**: Sequences of alphanumeric characters.
- **Verbatim Tokens**: Includes tags, punctuation, and whitespace if configured.
- **Stemming & Stop Words**:
    - **Stemming**: Reduces words to their roots to find matches with different grammatical forms.
    - **Stop Words**: Ignored in the first pass to focus on semantic content.
- **Tags & Protected Parts**:
    - Tags (e.g., `<f0>`) are treated as single tokens.
    - Protected parts are replaced with stable placeholders for matching/uniqueness/counting so they behave atomically.

## 6. Penalties and adjustments

Penalties reduce the similarity score to reflect qualitative differences that the distance formula might overlook.

| Penalty                   | Value      | Rationale                                                                         |
|:--------------------------|:-----------|:----------------------------------------------------------------------------------|
| **Fuzzy Flag**            | 5          | Matches previously marked as "fuzzy" in the TM are less reliable.                 |
| **Removed-text Mismatch** | 1          | Indicates the "removed text" logic found a discrepancy.                           |
| **Foreign Match**         | Default 30 | TM matches where the source/target locale differs from the project.               |
| **TMX-specific**          | Variable   | Custom patterns in TMX names can trigger specific penalties via configuration.    |

*Penalties are additive and applied before the final threshold check.*

## 7. Statistics definitions

### 7.1 Counting Rules
- **Segments**: Total count of unique and repeated segments.
- **Words**: Sequences of letters/digits. Tags are excluded. Protected parts are counted based on their "replacement words" value.
- **Characters**:
    - **With Spaces**: All characters including punctuation and whitespace.
    - **Without Spaces**: Excludes whitespace.
- **Exclusion**: Tags and placeholders are generally excluded from word counts but may be included in character counts depending on settings.

### 7.2 Uniqueness and Repetitions
- **Unique**: The first occurrence of a source string in the project.
- **Repetition within file**: Identical source appearing again in the same file.
- **Repetition from other files**: Identical source appearing in a file already processed.

### 7.3 Match Buckets (for Match Statistics)
Segments are binned based on their **best fuzzy match** found:

| Bucket          | Range / Criteria                                                 |
|:----------------|:-----------------------------------------------------------------|
| **Repetitions** | Identical source already seen in the project.                    |
| **Exact Match** | Already translated in the current project (Internal Score: 101). |
| **95%-100%**    | Fuzzy match score between 95 and 100 (excluding 101).            |
| **85%-94%**     | Fuzzy match score between 85 and 94.                             |
| **75%-84%**     | Fuzzy match score between 75 and 84.                             |
| **50%-74%**     | Fuzzy match score between 50 and 74.                             |
| **No Match**    | Below 50% or below project threshold.                            |

The buckets are defined in `MatchStatCounts`, counted in `MatchStatCount#addForPersent` and `MatchStatCount#addExact` methods.
They are used to calculate max similarity statistics in `CalcMatchStatistics#calcSimilarity`.

## 8. Performance & threading

- **Threading**:
    - Match finding runs in `FindMatchesThread` (one per request).
    - Statistics calculation runs in `CalcMatchStatistics`.
- **Thread Safety**: `LevenshteinDistance` and `FuzzyMatcher` instances are NOT thread-safe due to internal buffer reuse. Each thread must instantiate its own.
- **Caching**:
    - Tokenization results are often cached within a search session.
    - `FindMatches` maintains a local cache of matches to avoid redundant scoring.
- **Cancellation**: Long-running statistics tasks frequently check `isInterrupted()` that indicates callback to remain responsive to user cancellation.

## 9. Output & extensibility

- **Display**: The Matches pane uses HTML/Swing for display.
- **File Export**: `project_stats.txt`, `project_stats.xml`, and `project_stats.json` are generated based on configuration.
- **Extending**:
    - **New Calculator**: Implement `ISimilarityCalculator` and register it.
    - **New Stat Consumer**: Implement `IStatsConsumer` to receive streaming updates during calculation.
    - **Stability**: When adding new formats, ensure UTF-8 encoding and deterministic ordering of segments for version-control friendliness.
