# ADR: OmegaT CLI Modernization with PicoCLI

## Status
**Accepted** - Implementation in progress

## Context

The existing OmegaT command line interface suffered from several architectural and usability issues:

### Problems with Legacy CLI
- **Complex nested options**: Deep nesting made the CLI difficult to use and document
- **Monolithic architecture**: All CLI logic was centralized in the `CLIParameters` class and `Main` class
- **Poor documentation**: Help text was stored as a single large message in `Bundle.properties`, causing translation and maintenance issues
- **Limited extensibility**: No mechanism for plugins to add custom CLI commands
- **Inconsistent syntax**: Mixed patterns that didn't follow modern CLI conventions

### User Experience Issues
- PDF manual became unreadable due to excessive indentation from nested options
- Help system was monolithic and difficult to navigate
- No hierarchical help structure (e.g., `--help <command>`)
- Inconsistent command patterns across different operations

## Decision

We decided to modernize the OmegaT CLI by adopting **PicoCLI** as the command-line parsing library and restructuring the entire CLI architecture.

### Key Architectural Changes

#### 1. PicoCLI Integration
- Replace custom `CLIParameters` class with PicoCLI-based command structure
- Implement standard command-line patterns with proper sub-command support
- Leverage PicoCLI's automatic help generation and validation

#### 2. Modular Command Architecture
- Create dedicated command classes in `org.omegat.cli` package
- Implement `StandardCommands` class as the central command registry
- Each command becomes a self-contained class with its own logic and parameters

#### 3. New Command Structure
```
OmegaT [COMMAND] [SUB-COMMAND] [OPTIONS] [ARGUMENTS]
```

**Supported Commands:**
- `start` - Launch OmegaT GUI (default when no command specified)
- `team` - Team project management utilities
- `stats` - Statistics generation
- `translate` - Console translation mode
- `align` - Document alignment utilities

## Implementation Details

### Package Structure
```
org.omegat.cli/
├── Parameters.java          # Main CLI entry point
├── Command.java            # Base command interface
├── StandardCommands.java   # Command registry and implementations
├── AlignCommand.java       # Alignment operations
├── StatsCommand.java       # Statistics generation
├── StartCommand.java       # GUI startup
├── TranslateCommand.java   # Console translation
└── TeamCommand.java        # Team project operations
```

### Core Changes

#### Removed Components
- `CLIParameters` class (replaced by PicoCLI structure)
- Legacy CLI parsing logic in `Main` class
- Monolithic help text in `Bundle.properties`
- Deprecated CLI-related test classes

#### Added Components
- PicoCLI dependency integration
- Modular command classes with dedicated responsibilities
- Runtime preferences for CLI-specific parameters
- Enhanced help system with command-specific documentation

#### Modified Components
- `Main` class: Streamlined to delegate to PicoCLI
- `Core` class: Removed CLI parameter dependencies
- `ProjectPropertiesDialog`: Cleaned up CLI-related code
- Test suites: Updated to reflect new CLI structure

### Command Implementation Pattern

Each command follows a consistent pattern:

```java
@Command(name = "commandname", description = "Command description")
public class ExampleCommand implements Runnable {
    @Parameters(description = "Command parameters")
    private List<String> parameters;
    
    @Option(names = {"-o", "--option"}, description = "Option description")
    private String option;
    
    @Override
    public void run() {
        // Command implementation
    }
}
```

### Runtime Integration

- **Preferences**: New CLI parameters stored in `RuntimePreferences`
- **Lifecycle**: Commands handle their own execution lifecycle
- **Error Handling**: PicoCLI provides standardized error reporting
- **Validation**: Built-in parameter validation and type conversion

## Benefits

### For Users
- **Intuitive syntax**: Follows modern CLI conventions (similar to Git)
- **Better help system**: Hierarchical help with `--help` and `--help <command>`
- **Consistent patterns**: Uniform command structure across all operations
- **Improved documentation**: Clear, modular help text

### For Developers
- **Modular architecture**: Commands are self-contained and testable
- **Plugin extensibility**: Framework ready for plugin-based command extensions
- **Maintainable code**: Separation of concerns between commands
- **Standard library**: Leverages proven PicoCLI patterns and features

### For Translators
- **Granular messages**: Help text split into manageable, translatable units
- **Context preservation**: Command-specific help maintains proper context
- **Reduced complexity**: Smaller, focused translation units

## Migration Strategy

### Backward Compatibility
- Legacy command syntax continues to work during transition period
- Gradual deprecation of old patterns with clear migration guidance
- Existing scripts and integrations remain functional

### Rollout Plan
1. **Phase 1**: Core PicoCLI integration with basic commands
2. **Phase 2**: Advanced command features and plugin framework
3. **Phase 3**: Legacy CLI deprecation and removal

## Testing Strategy

### Test Coverage
- **Unit tests**: Individual command classes with focused test cases
- **Integration tests**: End-to-end CLI workflow validation
- **Regression tests**: Ensure backward compatibility during transition
- **Documentation tests**: Validate help text and command examples

### Quality Assurance
- Command parameter validation testing
- Error handling and user feedback verification
- Performance testing for large project operations
- Cross-platform CLI behavior validation

## Risks and Mitigations

### Dependencies
- **Risk**: Adding PicoCLI dependency increases application size
- **Mitigation**: PicoCLI is lightweight and provides significant value

### Complexity
- **Risk**: New architecture might introduce learning curve
- **Mitigation**: Comprehensive documentation and examples provided

### Migration
- **Risk**: Breaking changes for existing CLI users
- **Mitigation**: Backward compatibility maintained during transition

## Future Considerations

### Plugin System Integration
The new CLI architecture provides foundation for:
- Plugin-contributed commands
- Dynamic command registration
- Extensible parameter handling

### Advanced Features
- Command completion support
- Configuration file integration
- Enhanced scripting capabilities

## References

- [Original CLI Improvement Discussion](https://sourceforge.net/p/omegat/mailman/omegat-development/thread/245382296.961671.1706172007573%40mail.yahoo.com/#msg58728643)
- [PicoCLI Documentation](https://picocli.info/)
- [OmegaT CLI User Guide](https://omegat.sourceforge.io/manual-snapshot/en/chapter.how.to.html#how.to.running.omegat)
- [Command Implementation topic branch](https://github.com/omegat-org/omegat/pull/1321)

---

**Date**: 2024-01-30  
**Authors**: Hiroshi Miura, Thomas Cordonnier, Jean-Christophe Helary  
**Reviewers**: OmegaT Development Team  
**Status**: Implementation in Progress